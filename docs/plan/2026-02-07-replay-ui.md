---
title: 回放交互优化（模式切换/回放面板/蒙版）
status: 已上线
owner: codex
created: 2026-02-07
updated: 2026-02-07
---

## 背景
- 当前回放入口与控制分散：ChartView 右上角按钮 + 顶部导航 Replay 路由，且回放状态与 UI 文案并不一致。
- 回放需要在点击 K 线时展示对应绘图状态与因子数据，并提供播放控制，但右侧 Replay 面板仍是占位。
- 数据准备缺少“自动补算与落库”的前置步骤，导致回放时可能出现 ledger_out_of_sync。

## 目标 / 非目标
### 目标
- 顶部 Spot 行的 mode 组件右对齐，并可在 live/replay 间切换。
- 切换到 replay 时自动准备最近 2000 根 K 线的回放快照（因子数据 + 绘图指令 + 差值），必要时先补算并落库。
- 点击任意 K 线时间点后，右侧显示遮罩，展示该时刻绘图指令与因子数据，并在 Replay 面板提供播放控制。

### 非目标
- 不实现完整的 overlay replay package（window/snapshot/patch）协议输出。
- 不新增/改造 K 线数据源（仅复用现有 CandleStore 数据）。

## 方案概述
- 前端新增 replay 状态存储（非持久化），统一 mode/播放/指针/当前帧数据。
- ChartView 在 replay 模式下先调用后端 prepare 接口补算数据，再加载 candles + draw delta + factor slices。
- 点击 K 线时更新 replay 指针与蒙版位置，拉取对应 world frame 并更新 Replay 面板。
- 右侧 Replay 面板承载播放控制与数据展示；移除 ChartView 右上角 Replay 控件。
- 后端新增 replay prepare API：当 factor/overlay head 不足时触发补算并落库。

## 里程碑
1) 后端 prepare API + 文档
2) 前端 replay 状态与 UI 交互改造
3) E2E 用例 + 证据 + doc audit

## 任务拆解
- [ ] 后端：新增 `/api/replay/prepare`，检测 candle head 与 factor/overlay head，必要时触发 factor/overlay 补算并返回对齐信息。
- [ ] 前端：新增 replay store；ChartPanel mode 右对齐切换；ChartView replay 加载与蒙版；Replay 面板播放与数据展示；移除 ChartView 右上角按钮。
- [ ] 前端：新增回放 E2E 用例（Playwright）。
- [ ] 文档：更新 `docs/core/api/v1/http_world.md`（或新建 replay 文档），并跑 `bash docs/scripts/doc_audit.sh`。

## 风险与回滚
- 风险：prepare API 触发补算较慢 → 前端需展示 loading/错误态。
- 回滚：
  - 前端：`git revert` 对应提交，或将 replay store/面板改动移除。
  - 后端：撤销 `/api/replay/prepare` 路由与文档变更。

## 验收标准
- mode 组件位于 Spot 行右侧，点击可切换 live/replay。
- 切换 replay 时请求 prepare 接口并加载 2000 根 K 线快照；数据不足时会先补算再加载。
- 点击任意 K 线后出现右侧蒙版，绘图指令与因子数据在 Replay 面板展示。
- Replay 面板支持播放/暂停、速度、拖动进度条。
- 新增 E2E 用例通过，`pytest -q` 与 `cd frontend && npm run build` 通过。

## E2E 用户故事（门禁）

### Story ID / E2E Test Case（必须）
- Story ID（建议：`YYYY-MM-DD/<topic>/<short-scenario>`）：`2026-02-07/replay-ui/toggle-and-play`
- 关联 Plan：`docs/plan/2026-02-07-replay-ui.md`
- E2E 测试用例（必须写到具体文件 + 测试名）：
  - Test file path: `frontend/e2e/replay_mode.spec.ts`
  - Test name(s): `replay mode prepares data and plays`
  - Runner（pytest/playwright/…）：playwright

### Persona / Goal
- Persona：量化研究员
- Goal：切换到回放模式、点击某根 K 线查看该时刻绘图/因子数据，并在面板中播放回放。

### Entry / Exit（明确入口与出口）
- Entry：打开 `/live` 页面，点击 mode 切换为 replay
- Exit：Replay 面板显示当前时刻绘图/因子数据，蒙版生效，播放按钮可推进 K 线。

### Concrete Scenario（必须：写“具体数值”，禁止空泛）
- Chart / Symbol:
  - series_id / pair / timeframe: `binance:futures:BTC/USDT:5m`
  - timezone: UTC
- Initial State（明确数据前置）：
  - DB empty?: yes
  - Existing candles (at least 1) (exact values):
    - candle_time: 300
    - o/h/l/c/v: 1/1/1/1/10
- Trigger Event（明确触发点 + 时间）：
  - what happened: 通过 API 连续写入 40 根 closed candle（最后一根 `candle_time=12000`，close=40）
  - when: 测试前置阶段
  - new candle expected (exact values):
    - candle_time: 12000
    - o/h/l/c/v: 40/40/40/40/10
- Expected UI / API observable outcome（写具体）：
  - UI: Replay 面板中当前 candle_time == 12000（或回放指针对应时间）；蒙版可见
  - API: `/api/replay/prepare` 返回 `aligned_time == 12000`
  - API: `/api/market/candles` 返回最后一根 candle_time == 12000

### Preconditions（前置条件）
- 数据前置（fixtures / 环境变量 / 数据库初始状态）：使用 API 写入 40 根 candles；前端 localStorage 设定 timeframe=5m
- 依赖服务：backend + frontend 本地运行

### Main Flow（主流程步骤 + 断言）
1) Step:
   - User action: 进入 `/live`，点击 mode 切换 replay
   - Requests: `POST /api/replay/prepare?series_id=...&window_candles=2000`
   - Backend chain: main.py -> prepare handler -> factor_orchestrator.ingest_closed -> overlay_orchestrator.ingest_closed
   - Assertions: response.aligned_time == 12000；status=200
   - Evidence: Playwright 监听 response；日志输出在 test report

2) Step:
   - User action: 点击图表中间一根 K 线
   - Requests: `GET /api/frame/at_time?series_id=...&at_time=...`
   - Backend chain: main.py -> get_world_frame_at_time -> get_factor_slices + get_draw_delta
   - Assertions: Replay 面板展示 factor_slices.candle_id 对应点击时间；蒙版元素可见
   - Evidence: Playwright 断言 `[data-replay-mask]` 可见 + 面板文本包含 candle_id

3) Step:
   - User action: 点击 Replay 面板 Play
   - Requests: (前端本地播放)；必要时后续 `GET /api/frame/at_time`
   - Backend chain: ChartView 播放定时器 -> setReplayIndex
   - Assertions: `data-replay-index` 递增
   - Evidence: Playwright 读取 `data-replay-index` 比较前后值

### Produced Data（产生的数据）
- Tables / Files:
  - `backend/data/db.sqlite`:
    - candles (series_id, candle_time)
    - factor_events / factor_series_state
    - overlay_instruction_versions / overlay_series_state
  - how to inspect: sqlite 查询或后端 API

### Verification Commands（必须可复制运行）
- Command: `cd frontend && npm run build`
  - Expected：构建成功，无 TS 错误
- Command: `pytest -q`
  - Expected：全部通过
- Command: `cd frontend && npm run test:e2e -- --project=chromium --grep "replay mode prepares data and plays"`
  - Expected：用例通过，返回码 0

### Rollback（回滚）
- 最短回滚方式：`git revert <commit>` 回退前后端改动；删除 `/api/replay/prepare` 文档小节。

## 变更记录
- 2026-02-07: 创建（草稿）
