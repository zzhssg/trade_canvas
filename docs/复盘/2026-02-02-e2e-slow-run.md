---
title: 复盘：E2E 跑得很慢（Playwright 集成门禁）
status: 已完成
owner:
created: 2026-02-02
updated: 2026-02-02
---

## 背景

本仓门禁脚本 `bash scripts/e2e_acceptance.sh` 用于跑 FE+BE 集成 E2E（Playwright）。

在本次“overlay/delta 接入 + E2E 断言调整”迭代中，E2E 体感耗时明显偏长。

## 具体现象（证据）

- 单次 E2E（5 个 Playwright tests，1 worker）用时约 **41.5s**：
  - 证据：`/tmp/tc_e2e.log`（Playwright 输出尾部含 `3 passed (41.5s)`）
- E2E 过程中会触发大量 HTTP ingest：
  - 证据：`/tmp/tc_e2e.log` 中大量 `POST /api/market/ingest/candle_closed`（单个用例可达 200+ 次）
- 若端口占用，会被迫重复跑（额外拖慢）：
  - 证据：`scripts/e2e_acceptance.sh` 会在端口占用时报错退出（如 `backend port already in use: 8000`），需要先释放端口再重跑

## 影响与代价

- 反馈回路慢：每次改一个断言/细节都要等 30s~1min。
- 失败代价高：端口冲突/trace 损坏/偶发失败会迫使重复跑多次。

## 根因（聚焦 1–3 条）

1) **E2E 用例造数方式是“逐根 HTTP POST”**  
   - 目前没有批量 ingest 的 fastpath，导致大量 HTTP 往返与后端同步处理（即便单次很快，累计也显著）。

2) **E2E runner 默认包含“启动前后端 dev server”**  
   - `scripts/e2e_acceptance.sh` 每次启动 `uvicorn` + `vite dev`，再跑 Playwright；冷启动在快机器上也通常要数秒到十数秒，叠加后显著。

3) **环境与工序缺少“快跑模式”**（门禁与开发迭代共用同一套配置）  
   - 因子确认窗口（例如 `window_major=50`）会要求更长的 candle 序列来触发 pivot/pen 等事件，进一步放大造数成本。

## 如何避免（检查清单）

### 开发前

- [ ] 为 E2E 准备 **快跑模式 env**（例如降低 pivot window / 关掉非关键 stream），并在脚本中统一注入。
- [ ] 为 ingest 提供 **batch endpoint**（一次提交 N 根 closed candles），避免逐根 POST。

### 开发中

- [ ] 调试阶段优先跑单测 / 小集成（例如只测 `/api/draw/delta` 的语义），避免频繁全量 E2E。
- [ ] E2E 失败时先确认是否是“端口占用/trace 损坏/非业务错误”，避免误判为业务回归。

### 验收时

- [ ] E2E 门禁仍跑全量，但确保 **cache/依赖已就绪**（例如 Playwright 浏览器已安装，不在门禁时临时下载）。
- [ ] 交付证据附上：`/tmp/tc_e2e.log` + `output/playwright/`，避免复现困难。

## 关联

- 门禁脚本：`scripts/e2e_acceptance.sh`
- Playwright 产物：`output/playwright/`
- 本次日志证据：`/tmp/tc_e2e.log`
- 建议的改进方向（后续任务）：新增 batch ingest + E2E 快跑 env
