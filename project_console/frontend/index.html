<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Console</title>
    <style>
      :root {
        --bg-main: #040b16;
        --bg-panel: #0f1a2b;
        --bg-card: #131f33;
        --text-main: #e5edf9;
        --text-muted: #97aacd;
        --line: #22324f;
        --blue: #4a7dff;
        --blue-strong: #2d63ee;
        --green: #2dd194;
        --gray: #64748b;
        --danger-bg: #481f2a;
        --danger-text: #ffd6dd;
        --shadow: 0 10px 24px rgba(4, 8, 16, 0.35);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "SF Pro Text", "PingFang SC", "Segoe UI", sans-serif;
        color: var(--text-main);
        background:
          radial-gradient(1100px 480px at -15% -20%, rgba(50, 92, 189, 0.28), transparent),
          radial-gradient(900px 360px at 110% -10%, rgba(31, 145, 163, 0.22), transparent),
          var(--bg-main);
      }
      header {
        position: sticky;
        top: 0;
        z-index: 20;
        padding: 14px 20px;
        border-bottom: 1px solid rgba(130, 155, 198, 0.18);
        background: rgba(4, 11, 22, 0.82);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .title-wrap strong { font-size: 16px; letter-spacing: 0.2px; display: block; }
      .subtitle { color: var(--text-muted); font-size: 12px; margin-top: 2px; }
      .header-actions { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
      .search-input {
        width: min(280px, 42vw);
        border-radius: 8px;
        border: 1px solid #36527c;
        background: #12233f;
        color: #dce9ff;
        padding: 8px 10px;
        min-height: 36px;
        font-size: 12px;
      }
      .search-input::placeholder { color: #88a1c9; }
      .board { padding: 16px; display: grid; gap: 12px; max-width: 1540px; margin: 0 auto; }
      .col {
        background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent 16%), var(--bg-panel);
        border: 1px solid var(--line);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      .col h2 {
        margin: 0;
        padding: 12px 14px;
        font-size: 13px;
        border-bottom: 1px solid var(--line);
        color: #b4c8ec;
        letter-spacing: 0.3px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .col-count {
        font-size: 11px;
        color: #8facd8;
        background: #173257;
        border: 1px solid #345b8f;
        border-radius: 999px;
        padding: 1px 7px;
      }
      .list { padding: 10px; display: grid; gap: 8px; }
      .card {
        border: 1px solid #294066;
        border-radius: 10px;
        padding: 9px 10px;
        background: var(--bg-card);
      }
      .card-grid {
        display: grid;
        grid-template-columns: minmax(320px, 1.6fr) minmax(300px, 1.35fr) minmax(360px, 1.1fr);
        gap: 12px;
        align-items: center;
      }
      .project-lines {
        display: grid;
        gap: 6px;
        min-width: 0;
      }
      .project-line {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
      }
      .title {
        font-weight: 620;
        font-size: 13px;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .status-tag {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(255, 210, 122, 0.12);
        color: #ffd27a;
        white-space: nowrap;
      }
      .inline-label {
        color: #8ea8cf;
        font-size: 11px;
        white-space: nowrap;
      }
      .inline-path {
        color: #d3e3fc;
        font-size: 12px;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .meta-chip {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #37537f;
        background: #142747;
        color: #b8ccef;
        font-size: 11px;
        line-height: 1.4;
      }
      .meta-chip.main {
        border-color: #3e6f8d;
        background: #173548;
        color: #8dd7ff;
      }
      .service-panel { display: grid; gap: 6px; }
      .svc-row {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
        flex-wrap: nowrap;
      }
      .svc-meta {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        font-size: 12px;
        min-width: 0;
      }
      .svc-state { white-space: nowrap; }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        box-shadow: 0 0 0 2px rgba(15, 23, 40, 0.8);
      }
      .dot.running { background: var(--green); box-shadow: 0 0 0 2px rgba(45, 209, 148, 0.2); }
      .dot.stopped { background: var(--gray); }
      .svc-port { color: #bed0ee; font-size: 12px; }
      .svc-actions { display: inline-flex; gap: 6px; }
      .muted { color: var(--text-muted); font-size: 12px; line-height: 1.45; }
      .action-panel {
        display: flex;
        justify-content: flex-end;
        flex-wrap: nowrap;
        gap: 6px;
        align-items: center;
        justify-self: end;
      }
      .action-panel button { min-height: 30px; padding: 6px 10px; font-size: 11px; }
      .action-note { font-size: 11px; white-space: nowrap; }
      .icon-btn {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        border: 1px solid #2f476d;
        background: #1a2b49;
        color: #dbe8ff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 180ms ease, border-color 180ms ease;
      }
      .icon-btn:hover { background: #234179; border-color: #4a7dff; }
      .icon-btn svg { width: 20px; height: 20px; }
      .icon-btn.danger {
        background: #3c2230;
        border-color: #75435a;
        color: #ffd9e4;
      }
      .icon-btn.danger:hover { background: #5a3042; border-color: #be6e8d; }
      .icon-btn.success {
        background: #1f3f3a;
        border-color: #326d62;
        color: #ccfff0;
      }
      .icon-btn.success:hover { background: #285e55; border-color: #44a391; }
      button {
        border: 1px solid transparent;
        color: #fff;
        border-radius: 8px;
        padding: 8px 12px;
        min-height: 36px;
        font-size: 12px;
        line-height: 1;
        cursor: pointer;
        transition: transform 180ms ease, background 180ms ease, border-color 180ms ease, opacity 180ms ease;
      }
      button:hover { transform: translateY(-1px); }
      button:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }
      button.primary { background: var(--blue); }
      button.primary:hover { background: var(--blue-strong); }
      button.emphasis {
        background: linear-gradient(120deg, #3d8bff, #4a67ff);
        border-color: #7ca8ff;
        font-weight: 600;
        box-shadow: 0 8px 18px rgba(36, 85, 176, 0.35);
      }
      button.emphasis:hover { background: linear-gradient(120deg, #2f79ee, #3f5ff2); }
      button.secondary { background: #1d335f; border-color: #355487; }
      button.ghost { background: transparent; border-color: #36527c; color: #d8e6ff; }
      .empty { color: #5f7499; font-size: 12px; padding: 8px; }
      #error {
        margin: 10px auto 0;
        max-width: 1540px;
        padding: 10px 12px;
        border-radius: 8px;
        background: var(--danger-bg);
        color: var(--danger-text);
        display: none;
      }
      @media (max-width: 1500px) {
        .card-grid { grid-template-columns: minmax(300px, 1.5fr) minmax(280px, 1.25fr) minmax(320px, 1fr); }
      }
      @media (max-width: 1260px) {
        .card-grid { grid-template-columns: 1fr; gap: 8px; }
        .search-input { width: 100%; }
        .svc-row { flex-wrap: wrap; }
        .action-panel { justify-content: flex-start; justify-self: start; flex-wrap: wrap; }
      }
      @media (prefers-reduced-motion: reduce) {
        * { transition: none !important; }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title-wrap">
        <strong>Project Console</strong>
        <div class="subtitle">项目生命周期看板（草稿 / 开发中 / 待验收 / 已上线）</div>
      </div>
      <div class="header-actions">
        <input id="search" class="search-input" type="search" placeholder="搜索项目 / 分支 / 路径" />
        <button id="refresh" class="secondary">刷新</button>
      </div>
    </header>
    <div id="error"></div>
    <section class="board">
      <div class="col"><h2>草稿 <span class="col-count" id="count-draft">0</span></h2><div id="draft" class="list"></div></div>
      <div class="col"><h2>开发中 <span class="col-count" id="count-in_progress">0</span></h2><div id="in_progress" class="list"></div></div>
      <div class="col"><h2>待验收 <span class="col-count" id="count-pending_acceptance">0</span></h2><div id="pending_acceptance" class="list"></div></div>
      <div class="col"><h2>已上线 <span class="col-count" id="count-online">0</span></h2><div id="online" class="list"></div></div>
    </section>
    <script>
      const UI_STATE = { search: "" };
      const BUCKET_KEYS = ["draft", "in_progress", "pending_acceptance", "online"];

      function showError(msg) {
        const el = document.getElementById("error");
        if (!msg) { el.style.display = "none"; el.textContent = ""; return; }
        el.style.display = "block";
        el.textContent = msg;
      }

      async function postJson(url, payload) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload || {})
        });
        const body = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(body.detail || `HTTP ${res.status}`);
        return body;
      }

      async function bindPlan(project) {
        const initial = project.plan_path || "docs/plan/";
        const v = window.prompt("绑定 plan_path（示例：docs/plan/2026-02-08-xxx.md）", initial);
        if (!v) return;
        await postJson(`/api/projects/${project.worktree_id}/bind_plan`, { plan_path: v.trim() });
        await load();
      }

      async function setStatus(project, status) {
        await postJson(`/api/projects/${project.worktree_id}/status`, { status });
        await load();
      }

      async function testAction(project, action) {
        await postJson(`/api/projects/${project.worktree_id}/test/${action}`, {});
        await load();
      }

      async function testSingleAction(project, component, action) {
        await postJson(`/api/projects/${project.worktree_id}/test/${component}/${action}`, {});
        await load();
      }

      function makeButton(text, className, onClick) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = className;
        btn.textContent = text;
        btn.onclick = onClick;
        return btn;
      }

      function pathBasename(path) {
        if (!path) return "";
        const parts = String(path).split(/[\\/]/).filter(Boolean);
        return parts.length ? parts[parts.length - 1] : String(path);
      }

      function resolveProjectTitle(project) {
        const titled = [project.plan_title, project.description, project.branch]
          .map((v) => (v || "").trim())
          .find(Boolean);
        return titled || pathBasename(project.path) || "未命名项目";
      }

      function middleEllipsis(value, maxLength, headLength, tailLength) {
        const text = (value || "").trim();
        if (!text) return "";
        if (text.length <= maxLength) return text;
        return `${text.slice(0, headLength)}...${text.slice(-tailLength)}`;
      }

      function applySearchAndCounts() {
        const query = UI_STATE.search.trim().toLowerCase();
        for (const key of BUCKET_KEYS) {
          const bucket = document.getElementById(key);
          const cards = Array.from(bucket.querySelectorAll(".card"));
          let visible = 0;
          for (const card of cards) {
            const matched = !query || (card.dataset.search || "").includes(query);
            card.style.display = matched ? "" : "none";
            if (matched) visible += 1;
          }
          const count = document.getElementById(`count-${key}`);
          if (count) count.textContent = String(visible);

          let empty = bucket.querySelector(".empty");
          if (visible === 0) {
            if (!empty) {
              empty = document.createElement("div");
              empty.className = "empty";
              bucket.appendChild(empty);
            }
            empty.style.display = "block";
            empty.textContent = cards.length ? "无匹配项目" : "暂无项目";
          } else if (empty) {
            empty.style.display = "none";
          }
        }
      }

      function renderServiceRow(project, component, running, port, canControl) {
        const label = component === "backend" ? "B" : "F";
        const stateText = running ? "运行中" : "未启动";
        const dotClass = running ? "running" : "stopped";
        const row = document.createElement("div");
        const toggleTitle = running ? `停止${label}` : `启动${label}`;
        const toggleIcon = running
          ? '<svg viewBox="0 0 20 20" width="14" height="14" fill="currentColor" aria-hidden="true"><rect x="5" y="5" width="10" height="10" rx="1.5"></rect></svg>'
          : '<svg viewBox="0 0 20 20" width="14" height="14" fill="currentColor" aria-hidden="true"><path d="M7 5.5a1 1 0 0 1 1.53-.85l6 3.9a1 1 0 0 1 0 1.7l-6 3.9A1 1 0 0 1 7 13.3v-7.8z"></path></svg>';
        const restartTitle = component === "backend" ? "重启后端（热更新）" : "重启前端";
        row.className = "svc-row";
        row.innerHTML = `
          <div class="svc-meta">
            <span class="dot ${dotClass}" aria-hidden="true"></span>
            <span class="svc-state">${label} ${stateText}</span>
            <span class="svc-port">:${port || "-"}</span>
          </div>
          <div class="svc-actions">
            <button class="icon-btn ${running ? "danger" : "success"}" type="button" data-role="toggle" aria-label="${toggleTitle}" title="${toggleTitle}">
              ${toggleIcon}
            </button>
            <button class="icon-btn" type="button" data-role="restart" aria-label="${restartTitle}" title="${restartTitle}">
              <svg viewBox="0 0 20 20" width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M16 3v4h-4"></path>
                <path d="M16 7a6 6 0 1 0 1.4 5.8"></path>
              </svg>
            </button>
          </div>
        `;
        const toggleBtn = row.querySelector('button[data-role="toggle"]');
        const restartBtn = row.querySelector('button[data-role="restart"]');
        toggleBtn.disabled = !canControl;
        restartBtn.disabled = !canControl;
        toggleBtn.onclick = () => testSingleAction(project, component, running ? "stop" : "start").catch((e) => showError(String(e.message || e)));
        restartBtn.onclick = () => testSingleAction(project, component, "restart").catch((e) => showError(String(e.message || e)));
        return row;
      }

      function renderProjectCard(project) {
        const canControl = project.plan_status === "pending_acceptance" || project.is_main_project;
        const services = project.services || {};
        const backendRunning = !!services.backend_running;
        const frontendRunning = !!services.frontend_running;
        const projectTitle = resolveProjectTitle(project);
        const branchLabel = (project.branch || "").trim() || "detached";
        const planPathLabel = (project.plan_path || "").trim() || "未绑定计划文档";
        const planPathDisplay = middleEllipsis(planPathLabel, 44, 24, 16);
        const worktreePath = project.path || "-";
        const pathDisplay = middleEllipsis(worktreePath, 50, 26, 18);

        const card = document.createElement("article");
        card.className = "card";
        card.dataset.search = `${projectTitle} ${branchLabel} ${planPathLabel} ${worktreePath}`.toLowerCase();
        card.innerHTML = `
          <div class="card-grid">
            <div class="project-lines">
              <div class="project-line">
                <div class="title"></div>
                <span class="status-tag"></span>
                <span class="inline-label">计划</span>
                <span class="inline-path plan-path"></span>
              </div>
              <div class="project-line">
                <span class="meta-chip branch-chip"></span>
                <span class="inline-label">目录</span>
                <span class="inline-path workdir-path"></span>
                <span class="meta-chip main-chip">主项目</span>
              </div>
            </div>
            <div class="service-panel">
              <div class="backend-row"></div>
              <div class="frontend-row"></div>
            </div>
            <div class="action-panel"></div>
          </div>
        `;

        const titleEl = card.querySelector(".title");
        titleEl.textContent = projectTitle;
        titleEl.title = projectTitle;
        card.querySelector(".status-tag").textContent = project.plan_status_label;

        const planEl = card.querySelector(".plan-path");
        planEl.textContent = planPathDisplay;
        planEl.title = planPathLabel;

        const branchChip = card.querySelector(".branch-chip");
        branchChip.textContent = branchLabel;
        const workdirEl = card.querySelector(".workdir-path");
        workdirEl.textContent = pathDisplay;
        workdirEl.title = worktreePath;

        const mainChip = card.querySelector(".main-chip");
        if (project.is_main_project) {
          mainChip.classList.add("main");
        } else {
          mainChip.style.display = "none";
        }

        card.querySelector(".backend-row").appendChild(
          renderServiceRow(project, "backend", backendRunning, services.backend_port, canControl)
        );
        card.querySelector(".frontend-row").appendChild(
          renderServiceRow(project, "frontend", frontendRunning, services.frontend_port, canControl)
        );

        const actionPanel = card.querySelector(".action-panel");
        if (!project.plan_path) {
          actionPanel.appendChild(
            makeButton("绑定计划", "primary", () => bindPlan(project).catch((e) => showError(String(e.message || e))))
          );
        } else if (project.plan_status === "draft") {
          actionPanel.appendChild(
            makeButton("开始开发", "primary", () => setStatus(project, "in_progress").catch((e) => showError(String(e.message || e))))
          );
        } else if (project.plan_status === "in_progress") {
          actionPanel.appendChild(
            makeButton("标记待验收", "primary", () => setStatus(project, "pending_acceptance").catch((e) => showError(String(e.message || e))))
          );
        }

        if (canControl) {
          const running = backendRunning && frontendRunning;
          actionPanel.appendChild(
            makeButton(running ? "一键停止" : "一键启动", "primary", () => testAction(project, running ? "stop" : "start").catch((e) => showError(String(e.message || e))))
          );
          actionPanel.appendChild(
            makeButton("一键重启", "secondary", () => testAction(project, "restart").catch((e) => showError(String(e.message || e))))
          );
          if (services.frontend_port) {
            actionPanel.prepend(
              makeButton("打开测试页", "emphasis", () => window.open(`http://127.0.0.1:${services.frontend_port}`, "_blank"))
            );
          }
        }

        return card;
      }

      async function load() {
        showError("");
        const res = await fetch("/api/projects");
        const data = await res.json().catch(() => ({}));
        if (!res.ok) { showError(data.detail || `加载失败: HTTP ${res.status}`); return; }

        const buckets = {
          draft: document.getElementById("draft"),
          in_progress: document.getElementById("in_progress"),
          pending_acceptance: document.getElementById("pending_acceptance"),
          online: document.getElementById("online")
        };
        Object.values(buckets).forEach((el) => (el.innerHTML = ""));

        for (const p of data.projects) {
          const k = buckets[p.plan_status] ? p.plan_status : "draft";
          buckets[k].appendChild(renderProjectCard(p));
        }
        applySearchAndCounts();
      }

      document.getElementById("search").addEventListener("input", (event) => {
        UI_STATE.search = event.target.value || "";
        applySearchAndCounts();
      });
      document.getElementById("refresh").addEventListener("click", load);
      load();
    </script>
  </body>
</html>
