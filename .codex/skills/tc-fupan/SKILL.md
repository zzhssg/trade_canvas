---
name: tc-fupan
description: "Use when user says '复盘' to run a dev retrospective for trade_canvas: always (1) write mistakes and/or good practices to docs (docs/复盘 + docs/经验) while keeping docs/core in sync, (2) audit recent code for debt/bugs/redundancy, and (3) decide whether to pay down debt now vs continue feature work with explicit recommendation and thresholds; reply with exactly 3 themes."
metadata:
  short-description: 复盘沉淀 + 代码审计 + 技术债取舍（每次必输出 3 个主题）
---

# tc-fupan（复盘）

目标：把“对话中的好/坏决策”沉淀成可复用规则，并推动文档与代码持续对齐。

## 0) 定义复盘范围（必须）

- 默认覆盖：最近 3–8 轮对话 + 最近一次开发涉及的代码变更。
- 用证据圈定“最近开发的模块/链路”（至少给出一个）：`git status --porcelain`、`git diff --name-only`、`git log -n 10 --name-only`、当前打开的文件/目录。

## 1) 主题 1：复盘沉淀（错误 + 经验）→ `docs/复盘/` + `docs/经验/`（必须产出）

本主题把“错误复盘”和“经验沉淀”合并为一个主题输出：有则写两份文档，没有则按缺失项跳过。

### 1.1 错误复盘 → `docs/复盘/`（有则写；没有则跳过）

判定“错误/低质量”的常见信号（满足任一即可记录）：
- 测试/验收没覆盖真实 E2E 用户故事，导致“我以为 ok”但实际不通。
- 写了冗余/过度抽象/顺手重构，导致返工或维护性变差。
- 未对齐核心不变量/契约，导致接口语义漂移或数据不一致。
- 被用户指出（或你自己发现）明显疏漏：漏改、漏测、漏文档、漏回滚方案。

落盘规则：
- 新建一篇：`docs/复盘/YYYY-MM-DD-<slug>.md`（slug 用英文短词，避免空格；日期用当天）。
- 内容模板（按需精简，但必须包含“如何避免”）：
  - 背景（发生在什么任务/哪些文件/哪条链路）
  - 具体错误（可复现的现象/证据）
  - 影响与代价（返工/风险/性能/稳定性）
  - 根因（1–3 条，避免泛化）
  - 如何避免（写成检查清单：开发前/开发中/验收时各 3–5 条）
  - 关联：相关 PR/提交/文件路径/验证命令

### 1.2 经验沉淀 → `docs/经验/`（有则写；没有则跳过）

判定“值得沉淀”的常见信号：
- 先写最小可验收 E2E，再补实现；或先把契约/SoT 写清楚再编码。
- 修复遵循“可复现→根因→最小改动→回归保护”且验证证据充分。
- 文档与代码保持同步（尤其是 `docs/core/` 的核心链路/不变量/契约）。

落盘规则：
- 新建一篇：`docs/经验/YYYY-MM-DD-<slug>.md`。
- 内容模板：
  - 场景与目标
  - 做对了什么（可复用的动作/检查清单）
  - 为什么有效（机制/约束）
  - 复用方式（下次如何触发/在哪个阶段用）
  - 关联：文件路径/命令/截图点位（如有）

**保持 `docs/core/` 与代码同步（必须）**：
- 若本轮开发改变了核心链路/契约/不变量（例如 candle_id 对齐、closed/forming 边界、contracts、store schema、前后端契约），必须同步更新对应的 `docs/core/*.md`。
- 若新增了新的核心文档入口（或新增目录），同步更新 `docs/core/README.md`。

## 2) 主题 2：代码审计（技术债/bug/冗余/架构）→ 输出优先级清单

- 只聚焦“最近开发的模块/链路”（由第 0 步圈定）。
- 输出格式要求：
  - 给出 1–4 条问题，按优先级 `P0/P1/P2` 排序（P0=会错/会亏/会挂，P1=高概率返工/维护成本,垃圾架构，重复造轮子，P2=优化/美化）。
  - 每条包含：现象/风险 → 根因假设 → 最小修复建议 → 验证方式（测试/命令/断言）。

## 3) 主题 3：技术债取舍（修债 vs 继续开发功能）→ 明确建议（必须产出）

要求输出一个“现在该修债还是继续做功能”的决策建议，基于主题 2 的清单做取舍。

### 3.1 评估框架（必须逐条过一遍）

对主题 2 的每条 `P0/P1/P2`，补充 3 个判断维度（简短即可）：

- **用户价值/收益**：修完能带来什么（稳定性/一致性/更快交付/赚钱效率）。
- **风险与爆炸半径**：不修会不会导致数据不一致、契约漂移、难回滚、实盘风险。
- **成本与可验收性**：最小修复需要多少改动，是否能用现有门禁验证（pytest/build/e2e）。

### 3.2 决策输出（必须）

给出一个明确结论（只能二选一）：

- **建议优先修技术债**（列出要修的 1–3 条，为什么是现在修；给最小验收命令）
或
- **建议继续开发功能**（列出暂缓的 1–3 条技术债，说明为什么能暂缓；给触发“必须修”的门槛条件）

同时给出一个 **回滚/降级策略**（feature flag 或 `git revert` 路径）。

> 说明：本主题替代“产品迭代方向”作为每次必输出主题；若仍需要产品迭代方向，可作为主题 1/2 的附带小节，不单独占主题。

- 给 3 个方向（每个 3–5 行）：用户价值、实现代价、风险/依赖、可验收指标（最好可量化）。
- 明确推荐 1 个（说明为什么现在做它最划算：杠杆最大/依赖最少/风险最低/能带来更快闭环）。

## 输出约束（强制）

- **每次只输出 3 个主题**：必须包含主题 1、2、3（不得跳过）。
- 输出中必须引用证据：新建/更新的文档路径、关键文件路径、以及至少 1 条可运行的验证命令（如涉及代码/行为）。
- 做完文档改动后，运行：`bash docs/scripts/doc_audit.sh`。
