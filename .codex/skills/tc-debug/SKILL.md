---
name: tc-debug
description: Use when debugging bugs, flaky behavior, regressions, or unexpected outputs; enforces reproduce→isolate→fix→verify workflow.
metadata:
  short-description: 调试流程（可复现→根因→最小修复→验证）
---

# tc-debug（调试流程）

目标：把“猜”变成“证据链”，并确保修复可复现、可回归。

## 0) 先定义失败（必须）

- 明确：期望 vs 实际、触发条件、最小输入、失败信号（报错/日志/截图/断言）。
- 选一个**单一权威复现方式**（优先命令行脚本/测试，其次手动步骤）。

## 1) 复现（必须）

- 把复现步骤缩到最短（删掉无关步骤）。
- 固定变量：版本/配置/环境变量/输入数据。

## 2) 定位（必须）

- 画出链路：输入 → 关键中间态 → 输出（3–5 个关键节点即可）。
- 只加必要的观测：日志/断言/指标；不要先大改结构。
- 每次只验证一个假设：改动必须能证明/证伪某个假设。

## 2.5) 结构性根因扫描（必须）

- 先检查是否触发 `AGENTS.md`《结构复杂度硬约束 / 1) 文件大小门禁` 与 `6) 前端拆分约束》。
- 检查是否存在“伪抽象”：`Policy` / `Registry` / `Router` 仅包装单个纯函数或 dict 转发。
- 检查接口膨胀：按 `AGENTS.md`《结构复杂度硬约束 / 3) 接口约束》核对参数与字段体量。
- 检查依赖反向：按 `AGENTS.md`《结构复杂度硬约束 / 4) 依赖方向规则》核对是否出现反向依赖或越层访问。
- 若命中结构性问题，修复顺序改为：先最小拆分降耦合，再修行为 bug，并补对应回归。

## 2.6) 红旗到动作映射（必须）

- 命中 `R5` 透传方法：优先合并调用链或把逻辑下沉到被调用模块（对应 `P9`）。
- 命中 `R3` 时间分解：按信息隐藏重组模块边界（对应 `P8`）。
- 命中 `R2` 信息泄漏：收敛重复决策到单一模块接口（对应 `P4`/`P6`）。
- 命中 `R6` 重复实现：抽取通用能力并与专用分离（对应 `P7`/`P14`）。
- 命中 `R11`/`R12`/`R13`：先做命名与接口收敛，必要时补非显然注释（对应 `P12`/`P13`）。

## 3) 根因与最小修复（必须）

- 写一句话根因：**“因为 X，所以 Y，在 Z 条件下失败”**。
- 优先“定义错误不存在”：先通过类型/契约/不变量/前置校验让错误路径不可表达，再补必要兜底（不要只叠加 if/except）。
- 做最小改动修复根因（避免“顺手重构”）。
- 加一条回归保护：优先测试；没有测试则加可自动运行的复现脚本。

## 4) 验证与收尾（必须）

- 运行：复现用例（变绿）+ 相关测试/构建。
- 运行：`bash scripts/quality_gate.sh --fast`（结构门禁，确保未引入兼容层/遗留双轨/临时债）。
- 说明：改动点、为何能覆盖根因、如何回滚。
