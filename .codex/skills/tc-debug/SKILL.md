---
name: tc-debug
description: Use when debugging bugs, flaky behavior, regressions, or unexpected outputs; enforces reproduce→isolate→fix→verify workflow.
metadata:
  short-description: 调试流程（可复现→根因→最小修复→验证）
---

# tc-debug（调试流程）

目标：把“猜”变成“证据链”，并确保修复可复现、可回归。

## 0) 先定义失败（必须）

- 明确：期望 vs 实际、触发条件、最小输入、失败信号（报错/日志/截图/断言）。
- 选一个**单一权威复现方式**（优先命令行脚本/测试，其次手动步骤）。

## 1) 复现（必须）

- 把复现步骤缩到最短（删掉无关步骤）。
- 固定变量：版本/配置/环境变量/输入数据。

## 2) 定位（必须）

- 画出链路：输入 → 关键中间态 → 输出（3–5 个关键节点即可）。
- 只加必要的观测：日志/断言/指标；不要先大改结构。
- 每次只验证一个假设：改动必须能证明/证伪某个假设。

## 2.5) 结构性根因扫描（必须）

- 先检查是否触发复杂度硬约束：Python 文件 `>300` 行、TSX `>400` 行（或 `>300` 且持续叠加职责）、hook `>150` 行。
- 检查是否存在“伪抽象”：`Policy` / `Registry` / `Router` 仅包装单个纯函数或 dict 转发。
- 检查接口膨胀：函数参数是否 `>8`、dataclass/配置对象字段是否 `>15`。
- 检查依赖反向：`read_model -> ingest`、`route -> store` 直连、或双向依赖。
- 若命中结构性问题，修复顺序改为：先最小拆分降耦合，再修行为 bug，并补对应回归。

## 3) 根因与最小修复（必须）

- 写一句话根因：**“因为 X，所以 Y，在 Z 条件下失败”**。
- 优先“定义错误不存在”：先通过类型/契约/不变量/前置校验让错误路径不可表达，再补必要兜底（不要只叠加 if/except）。
- 做最小改动修复根因（避免“顺手重构”）。
- 加一条回归保护：优先测试；没有测试则加可自动运行的复现脚本。

## 4) 验证与收尾（必须）

- 运行：复现用例（变绿）+ 相关测试/构建。
- 说明：改动点、为何能覆盖根因、如何回滚。
